<!DOCTYPE html>
<html>
<head>
    <title>rBrowser v1.0 - NomadNet Nodes Standalone Page Browser</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="main">
        <div class="sidebar" style="position: relative; max-width: 210px !important;">
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" class="node-search" id="node-search" placeholder="Search nodes by name or hash..." onkeyup="filterNodes()" oninput="toggleClearButton()">
                    <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">√ó</button>
                </div>
            </div>
            <div class="node-list-container" style="position: absolute !important; top: 50px !important; bottom: 38px !important; left: 0 !important; right: 0 !important; overflow-y: auto !important;">
                <div class="node-list" id="node-list">
                    <div style="text-align: center; padding: 20px; color: #7d8590; font-size: 12px;">Scanning for nodes...</div>
                </div>
            </div>
            <div class="status-bar" style="position: absolute !important; bottom: 0 !important; left: 0 !important; right: 0 !important; padding: 4px 8px !important; margin: 0 !important; font-size: 12px !important; line-height: 1.1 !important; height: 38px !important; min-height: 38px !important; max-height: 38px !important; box-sizing: border-box !important;">
                Status:<span class="online"><strong> ‚óè Online.  Reticulum Connected!</strong></span><br>
                ‚óèTotal Announces: <span class="count" id="announce-count">0</span> ‚óèNomadNet Nodes: <span class="count" id="node-count">0</span>                
            </div>
        </div>
        <div class="content">
            <div class="nav-bar">
                <div class="nav-controls">
                    <button class="nav-btn" id="back-btn" onclick="navigateBack()" disabled>‚Üê</button>
                    <button class="nav-btn" id="forward-btn" onclick="navigateForward()" disabled>‚Üí</button>
                    <button class="nav-btn" onclick="refreshPage()">‚ü≥</button>
                </div>
                <input type="text" class="address-bar" id="address-bar" placeholder="Enter NomadNet URL (hash:/path/to/page.mu)" onkeypress="handleAddressBarEnter(event)">
                <button class="go-btn" onclick="navigateToUrl()">Go</button>
            </div>
            <div class="header">
                <div class="page-title" id="page-title"><br>Waiting for Announces... Select a node from the list to navigate pages</div>
                <div class="page-url" id="page-url"></div>
                <button class="view-toggle" id="view-toggle" onclick="toggleView()">Raw View</button>
            </div>
            <div class="browser-area">
                <div class="page-content" id="page-content">
                    <div class="welcome">
                        <h2>rBrowser v1.0</h2>
                        <p>Welcome to the NomadNet Standalone Browser.<br>This browser connects to Reticulum and listens for NomadNetwork Nodes serving pages.<br>Wait for announces and select a node from the sidebar to explore the distributed content.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load DOMPurify for security -->
    <script src="../script/purify.min.js"></script>

    <script>
        let selectedNode = null;
        let currentRequest = null;
        let currentRawContent = '';
        let isRawView = false;
        let micronParser = null;
        let isOriginalParser = false;
        let navigationHistory = [];
        let historyIndex = -1;
        let currentUrl = '';
        let cachedNodes = [];

        // Get Node Name function
        function getNodeName(hash) {
            console.log('Looking for hash:', hash);
            console.log('Cached nodes available:', cachedNodes.length);
    
            // First try to find in DOM
            const nodeItem = document.querySelector(`[data-hash="${hash}"]`);
            if (nodeItem) {
                const nodeName = nodeItem.getAttribute('data-name');
                console.log('Getting node name for hash:', hash, '-> Name (from DOM):', nodeName);
                return nodeName;
            }
    
            // If not in DOM, check cached nodes data
            const cachedNode = cachedNodes.find(node => {
                console.log('Comparing:', hash, 'vs', node.hash);
                return node.hash === hash;
            });
    
            if (cachedNode) {
                console.log('Getting node name for hash:', hash, '-> Name (from cache):', cachedNode.name);
                return cachedNode.name;
            }
    
            console.log('Getting node name for hash:', hash, '-> Name (fallback):', hash);
            return hash;
        }

        // Initialize MicronParser
        async function initializeMicronParser() {
            try {
                console.log('Initializing MicronParser...');
                
                // Load the original micron parser script
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = './script/micron-parser_original.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                // Wait for script to execute
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Try to initialize the parser
                if (typeof window.MicronParser === 'function') {
                    micronParser = new window.MicronParser(true, true);
                    isOriginalParser = true;
                    console.log('‚úÖ Original MicronParser loaded successfully');
                } else {
                    throw new Error('MicronParser not available');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Original parser failed, using fallback:', error.message);
                micronParser = createFallbackParser();
                isOriginalParser = false;
            }
        }

        function createFallbackParser() {
            return {
                convertMicronToHtml: function(text) {
                    let html = text;
                    
                    // Basic Micron formatting (simplified)
                    html = html.replace(/`!([^`]*)`!/g, '<strong style="color: #58a6ff; font-weight: bold;">$1</strong>');
                    html = html.replace(/`\*([^`]*)`\*/g, '<em style="color: #ffa657; font-style: italic;">$1</em>');
                    html = html.replace(/`_([^`]*)`_/g, '<span style="text-decoration: underline; color: #79c0ff;">$1</span>');
                    html = html.replace(/^>([^\n]*)/gm, '<div style="color: #58a6ff; font-weight: bold; font-size: 18px; margin: 16px 0 8px 0; border-bottom: 1px solid #30363d; padding-bottom: 4px;">$1</div>');
                    html = html.replace(/\n/g, '<br>');
                    
                    // Escape HTML
                    html = escapeHtml(html);
                    
                    return `<div style="font-family: 'Courier New', 'Liberation Mono', 'DejaVu Sans Mono', Courier, monospace; line-height: 1.6;">${html}</div>`;
                }
            };
        }

        function parseMicronContent(content) {
            if (!content) return '';
            
            console.log('Parsing Micron content, length:', content.length);
            
            if (micronParser) {
                let html = micronParser.convertMicronToHtml(content);
                
                // Add click handlers to any links that the original parser created
                html = addClickHandlersToLinks(html);
                
                console.log('Micron parsing complete');
                return html;
            } else {
                console.log('No parser available, returning escaped HTML');
                return escapeHtml(content);
            }
        }

        function addClickHandlersToLinks(html) {
            // Find existing <a> tags and add navigation handlers if they look like NomadNet URLs
            return html.replace(/<a([^>]*?)href=["']([^"']*?)["']([^>]*?)>/g, function(match, before, href, after) {
                // Check if it's a NomadNet URL format
                if (isNomadNetUrl(href)) {
                    const url = normalizeNomadNetUrl(href);
                    return `<a${before} href="#" class="nomadnet-link" onclick="navigateToNomadNetUrl('${url}'); return false;" title="Navigate to ${url}"${after}>`;
                }
                return match; // Keep other links as-is
            });
        }

        function isNomadNetUrl(url) {
            // Check if URL looks like a NomadNet URL
            return url.match(/^(nomadnetwork:\/\/|[a-fA-F0-9<>:]{32,}[:\/])/);
        }

        function normalizeNomadNetUrl(url) {
            // Convert various formats to our standard format: hash:/path
            if (url.startsWith('nomadnetwork://')) {
                const match = url.match(/nomadnetwork:\/\/([a-fA-F0-9<>:]+)(\/.*)?/);
                if (match) {
                    const cleanHash = match[1].replace(/[<>:]/g, '');
                    const path = match[2] || '/page/index.mu';
                    return `${cleanHash}:${path}`;
                }
            }
            return url;
        }

        function navigateToNomadNetUrl(url) {
            console.log('Link clicked! Navigating to:', url);
            const addressBar = document.getElementById('address-bar');
            addressBar.value = url;
            navigateToUrl();
        }

        function parseNomadNetUrl(url) {
            console.log('Parsing URL:', url);
            
            // Clean up common URL prefixes
            url = url.replace(/^nomadnetwork:\/\//, '');
            
            // Match hash and optional path
            const match = url.match(/^([a-fA-F0-9<>:]{32,})(?:[:\/](.*))?$/);
            if (match) {
                const cleanHash = match[1].replace(/[<>:]/g, '');
                let path = match[2];
                
                // Default to index page if no path
                if (!path || path === '') {
                    path = 'page/index.mu';
                }
                
                // Ensure path starts with /
                if (!path.startsWith('/')) {
                    path = '/' + path;
                }
                
                console.log('Parsed URL - Hash:', cleanHash.substring(0, 16) + '...', 'Path:', path);
                return { hash: cleanHash, path: path };
            }
            
            console.log('Failed to parse URL:', url);
            return null;
        }

        function addToHistory(url) {
            if (url !== currentUrl) {
                // Remove any forward history when navigating to new page
                navigationHistory = navigationHistory.slice(0, historyIndex + 1);
                navigationHistory.push(url);
                historyIndex = navigationHistory.length - 1;
                currentUrl = url;
                updateNavigationButtons();
                console.log('Added to history:', url);
            }
        }

        function updateNavigationButtons() {
            const backBtn = document.getElementById('back-btn');
            const forwardBtn = document.getElementById('forward-btn');
            
            backBtn.disabled = historyIndex <= 0;
            forwardBtn.disabled = historyIndex >= navigationHistory.length - 1;
        }

        function navigateBack() {
            if (historyIndex > 0) {
                historyIndex--;
                const url = navigationHistory[historyIndex];
                currentUrl = url;
                document.getElementById('address-bar').value = url;
                navigateToUrlInternal(url, false);
                updateNavigationButtons();
                console.log('Navigated back to:', url);
            }
        }

        function navigateForward() {
            if (historyIndex < navigationHistory.length - 1) {
                historyIndex++;
                const url = navigationHistory[historyIndex];
                currentUrl = url;
                document.getElementById('address-bar').value = url;
                navigateToUrlInternal(url, false);
                updateNavigationButtons();
                console.log('Navigated forward to:', url);
            }
        }

        function refreshPage() {
            if (currentUrl) {
                console.log('Refreshing page:', currentUrl);
                navigateToUrlInternal(currentUrl, false);
            }
        }

        function handleAddressBarEnter(event) {
            if (event.key === 'Enter') {
                navigateToUrl();
            }
        }

        function navigateToUrl() {
            const url = document.getElementById('address-bar').value.trim();
            if (url) {
                console.log('Manual navigation to:', url);
                navigateToUrlInternal(url, true);
            }
        }

        function navigateToUrlInternal(url, addHistory = true) {
            const parsed = parseNomadNetUrl(url);
            if (!parsed) {
                alert('Invalid NomadNet URL format. Examples:\n- abcd1234...:/page/index.mu\n- nomadnetwork://abcd1234.../page/index.mu');
                return;
            }

            if (addHistory) {
                addToHistory(url);
            }

            console.log('Navigating to parsed URL:', parsed);
            console.log('üî• About to call fetchPageByUrl with:', parsed.hash, parsed.path, url);
            fetchPageByUrl(parsed.hash, parsed.path, url);
        }

        // TODO: This only works with static links, it needs to be expanded further for form support and more.
        function navigateToLink(url, addHistory = true) {
            const parsedCurrent = parseNomadNetUrl(currentUrl);
            if (!parsedCurrent) {
                alert('Invalid NomadNet URL format. Examples:\n- abcd1234...:/page/index.mu\n- nomadnetwork://abcd1234.../page/index.mu');
                return;
            }

            let parsed = parseNomadNetUrl(url);
            if (!parsed) {
                parsed = {
                    hash: parsedCurrent.hash,
                    path: url.startsWith(':') ? url.substring(1) : url
                };
            }

            if (url.startsWith(':')) {
                url = parsed.hash + url;
            }

            if (addHistory) {
                addToHistory(url);
            }            

            console.log('Navigating to parsed URL:', parsed);
            console.log('üî• About to call fetchPageByUrl with:', parsed.hash, parsed.path, url);
            fetchPageByUrl(parsed.hash, parsed.path, url);
        }

        function fetchPageByUrl(hash, path, originalUrl) {
            if (currentRequest) {
                console.log('Cancelling previous request');
                currentRequest.abort();
                currentRequest = null;
            }
            
            selectedNode = hash;
            const nodeName = getNodeName(hash);
            document.getElementById('page-title').innerHTML = `<br>Loading Nomadnet Page: <strong>${nodeName}</strong>...`;
            document.getElementById('page-url').textContent = '';
            document.getElementById('page-content').innerHTML = `<div style="color: #58a6ff; text-align: center; padding: 40px; font-size: 16px;">Loading NomadNet page:<br><br><strong>${nodeName}</strong><br><br>Please wait...</div>`;
            document.getElementById('view-toggle').style.display = 'none';
            document.getElementById('address-bar').value = originalUrl;
            
            // Update selected node in sidebar
            document.querySelectorAll('.node-item').forEach(item => item.classList.remove('selected'));
            const nodeItem = document.querySelector(`[data-hash="${hash}"]`);
            if (nodeItem) {
                nodeItem.classList.add('selected');
            }
            
            const controller = new AbortController();
            currentRequest = controller;
            
            console.log('Fetching page from API:', `/api/fetch/${hash}?path=${encodeURIComponent(path)}`);
            
            fetch(`/api/fetch/${hash}?path=${encodeURIComponent(path)}`, { signal: controller.signal })
                .then(r => r.json())
                .then(response => {
                    if (currentRequest === controller) {
                        if (response.status === 'success') {
                            console.log('Page loaded successfully, content length:', response.content.length);
                            currentRawContent = response.content;
                            isRawView = false;
                            
                            // Parse and render with MicronParser
                            const renderedHtml = parseMicronContent(response.content);
                            document.getElementById('page-content').innerHTML = renderedHtml;
                            document.getElementById('page-content').className = 'page-content';
                            
                            const nodeName = getNodeName(hash);
                            document.getElementById('page-title').innerHTML = `<strong>${nodeName}</strong>  <span style="color: #7d8590; font-size: 12px;"> ${path} </span>`;
                            document.getElementById('page-url').textContent = originalUrl;
                            document.getElementById('view-toggle').style.display = 'block';
                            document.getElementById('view-toggle').textContent = 'Raw View';
                            
                            console.log('Page rendered with', isOriginalParser ? 'original' : 'fallback', 'parser');
                            
                            // Count links found
                            const links = document.querySelectorAll('#page-content a')
                            const linkCount = links.length;
                            console.log('Found', linkCount, 'links in content');

                            function handleClick(event) {
                                event.preventDefault(); // Prevent default link behavior
    
                                const action = this.getAttribute('data-action');
                                const destination = this.getAttribute('data-destination');
                                const fields = this.getAttribute('data-fields');
    
                                console.log('Action:', action, 'Destination:', destination, 'Fields:', fields);
    
                                // Check if destination contains LXMF address
                                if (destination && destination.includes('lxmf@')) {
                                    // Show informational alert for LXMF addresses
                                    alert("This is an LXMF address, use official LXMF clients to open this link and chat with the peer (MeshChat, Sideband)");
                                    return;
                                }
    
                                // Check if destination contains HTTP/HTTPS URL
                                if (destination && (destination.includes('http://') || destination.includes('https://'))) {
                                    // Extract the actual HTTP URL
                                    let httpUrl = destination;
        
                                    // If it's wrapped in nomadnetwork:// format, extract the inner URL
                                    if (destination.startsWith('nomadnetwork://')) {
                                        httpUrl = destination.replace('nomadnetwork://', '');
                                    }
        
                                    // Show confirmation dialog
                                    const userConfirmed = confirm("Open HTTP/HTTPS URL in a new browser window?\n\nURL: " + httpUrl);
        
                                    if (userConfirmed) {
                                        // Open in new window/tab
                                        window.open(httpUrl, '_blank', 'noopener,noreferrer');
                                    }
                                    // If user clicks "No", just return and do nothing
                                    return;
                                }
    
                                // For regular NomadNet links, proceed with normal navigation
                                navigateToLink(destination);
                            }

                            links.forEach(link => {
                                link.addEventListener('click', handleClick);
                            });
                            
                        } else {
                            console.log('Failed to load page:', response.error);
                            document.getElementById('page-content').innerHTML = `<div class="error">Failed to load page: ${escapeHtml(response.error)}<br><br>This could be due to network issues or the node being offline.</div>`;
                            document.getElementById('page-title').textContent = `Error loading ${originalUrl}`;
                            document.getElementById('page-url').textContent = '';
                            document.getElementById('view-toggle').style.display = 'none';
                        }
                        currentRequest = null;
                    }
                })
                .catch(err => {
                    if (currentRequest === controller && !controller.signal.aborted) {
                        console.log('Network error:', err.message);
                        document.getElementById('page-content').innerHTML = `<div class="error">Network error: ${escapeHtml(err.message)}<br><br>Please check your connection and try again.</div>`;
                        document.getElementById('page-title').textContent = `Error loading ${originalUrl}`;
                        document.getElementById('page-url').textContent = '';
                        document.getElementById('view-toggle').style.display = 'none';
                        currentRequest = null;
                    }
                });
        }

        function toggleView() {
            const content = document.getElementById('page-content');
            const toggle = document.getElementById('view-toggle');
            
            if (isRawView) {
                // Switch to rendered view
                console.log('Switching to rendered view');
                const renderedHtml = parseMicronContent(currentRawContent);
                content.innerHTML = renderedHtml;
                content.className = 'page-content';
                
                // Re-add event handlers after switching to rendered view
                const links = document.querySelectorAll('#page-content a');
                console.log('Re-adding event handlers to', links.length, 'links');
                
                function handleClick() {
                    const action = this.getAttribute('data-action');
                    const destination = this.getAttribute('data-destination');
                    const fields = this.getAttribute('data-fields');
                    console.log('Action:', action, 'Destination:', destination, 'Fields:', fields);
                    navigateToLink(destination);
                }

                links.forEach(link => {
                    link.addEventListener('click', handleClick);
                });
                
                toggle.textContent = 'Raw View';
                isRawView = false;
                
                // Count links after rendering
                const linkCount = links.length;
                console.log('Rendered view shows', linkCount, 'links');
            } else {
                // Switch to raw view
                console.log('Switching to raw view');
                content.innerHTML = escapeHtml(currentRawContent);
                content.className = 'page-content raw';
                toggle.textContent = 'Rendered View';
                isRawView = true;
            }
        }

        function updateNodes() {
            fetch('/api/nodes')
                .then(r => r.json())
                .then(nodes => {
                    cachedNodes = nodes;
                    console.log('Cached nodes updated:', cachedNodes.length, 'nodes');
                    console.log('First cached node hash example:', cachedNodes.length > 0 ? cachedNodes[0].hash : 'none');

                    const list = document.getElementById('node-list');
                    const searchTerm = document.getElementById('node-search').value.toLowerCase(); // Save current search
                    
                    if (nodes.length === 0) {
                        list.innerHTML = '<div style="text-align: center; padding: 20px; color: #7d8590; font-size: 12px;">Scanning for NomadNet Nodes...</div>';
                        return;
                    }
                    
                    let html = '';
                    nodes.forEach((node, i) => {
                        const selected = selectedNode === node.hash ? 'selected' : '';
                        html += `
                            <div class="node-item ${selected}" id="node-${i}" data-hash="${escapeHtml(node.hash)}" data-name="${escapeHtml(node.name)}">
                                <div class="node-title">${escapeHtml(node.name)}</div>
                                <div class="node-hash">${node.hash}</div>
                                <div class="node-info">üìä ${node.app_data_length} bytes announced ‚Ä¢ ${node.last_seen_relative}</div>
                            </div>
                        `;
                    });
                    
                    list.innerHTML = html;
                    
                    // Reapply search filter if there was one
                    if (searchTerm) {
                        filterNodes();
                    }
                    
                    document.querySelectorAll('.node-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            const hash = this.getAttribute('data-hash');
                            const name = this.getAttribute('data-name');
                            browseNode(hash, name);
                        });
                    });
                    
                    document.getElementById('node-count').textContent = nodes.length;
                });
        }
        
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('announce-count').textContent = data.total_announces;
                });
        }
        
        function browseNode(hash, name) {
            const url = `${hash}:/page/index.mu`;
            console.log('Browsing node:', name, 'URL:', url);
            document.getElementById('address-bar').value = url;
            navigateToUrlInternal(url, true);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function filterNodes() {
            const searchTerm = document.getElementById('node-search').value.toLowerCase();
            const nodeItems = document.querySelectorAll('.node-item');
    
            nodeItems.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                const hash = item.getAttribute('data-hash').toLowerCase();
        
                if (name.includes(searchTerm) || hash.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
    
            // Update visible count
            const visibleNodes = document.querySelectorAll('.node-item[style*="block"], .node-item:not([style*="none"])').length;
            if (searchTerm) {
                console.log(`Filtered to ${visibleNodes} nodes matching "${searchTerm}"`);
            }
        }

        function toggleClearButton() {
            const searchInput = document.getElementById('node-search');
            const clearButton = document.getElementById('search-clear');
            
            if (searchInput.value.length > 0) {
                clearButton.style.display = 'flex';
            } else {
                clearButton.style.display = 'none';
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('node-search');
            const clearButton = document.getElementById('search-clear');
            
            searchInput.value = '';
            clearButton.style.display = 'none';
            filterNodes(); // Reapply filter (which will show all nodes)
            searchInput.focus(); // Keep focus on search input
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('NomadNet Browser starting...');
            await initializeMicronParser();
            
            // Start regular updates
            setInterval(() => {
                updateNodes();
                updateStatus();
            }, 3000);
            
            // Initial load
            updateNodes();
            updateStatus();
            
            console.log('Browser initialization complete');
        });
    </script>
</body>
</html>